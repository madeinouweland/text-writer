<!doctype html>
<html lang="en">
<head>
  <title>Dropbox access granted</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/screen.css">
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/4.0.9/Dropbox-sdk.min.js"></script>
  <script src="./utils.js"></script>
</head>
<body>
  <div id="container">
    <h1>Text-writer now has access to your dropbox folder Apps/text-writer.</h1>
    <button onclick="start();">Start writing</button>
  </div>
  <script>
      (function(window){
      window.utils = {
        parseQueryString: function(str) {
          var ret = Object.create(null);

          if (typeof str !== 'string') {
            return ret;
          }

          str = str.trim().replace(/^(\?|#|&)/, '');

          if (!str) {
            return ret;
          }

          str.split('&').forEach(function (param) {
            var parts = param.replace(/\+/g, ' ').split('=');
            // Firefox (pre 40) decodes `%3D` to `=`
            // https://github.com/sindresorhus/query-string/pull/37
            var key = parts.shift();
            var val = parts.length > 0 ? parts.join('=') : undefined;

            key = decodeURIComponent(key);

            // missing `=` should be `null`:
            // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
            val = val === undefined ? null : decodeURIComponent(val);

            if (ret[key] === undefined) {
              ret[key] = val;
            } else if (Array.isArray(ret[key])) {
              ret[key].push(val);
            } else {
              ret[key] = [ret[key], val];
            }
          });

          return ret;
        }
      };
    })(window);

    // assume the user allowed access and dropbox redirected here with an access token
    var token = utils.parseQueryString(window.location.hash).access_token;
    window.localStorage.setItem("token", token);

    function start(){
      window.location.href='./index.html';
    }
  </script>
</body>
</html>
